---
title: "OA Dashboard"
author: "Tom Saunders"
output:
  html_document:
    css: "style.css"
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'index.html')) })
---
```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(fig.align="center")
library(tidyverse)
```

This dashboard displays data extracted from the Open Alex API relating to scholarly publication output in Aotearoa New Zealand. [This query](https://github.com/tesaunders/oa-nz/blob/main/query-overall.R) extracts national-level data to see how the country is tracking against the Universities New Zealand target of 70% open access output, while [this query](https://github.com/tesaunders/oa-nz/blob/main/query-institution.R) extracts data relating to individual research institutions (or at least the ones with the largest publication output). 

The below dashboard displays a series of plots to show trends in open access publications since 2010. OpenAlex data for some institutions is very incomplete (such as NIWA). Institutions like Te Pūkenga do not currently have publications from child organisations pooled at the parent level, but I've added Te Pūkenga here in the hope this changes at some point. 

All code, plots, and summarised data can be found [here](https://github.com/tesaunders/oa-nz).

## National Data

```{r, fig.dim = c(8, 6)}
library(tidyverse)

# Get previous year

prev_year <- as.numeric(format(Sys.Date(), "%Y"))-1

# Read in data generated by both queries

data_overall <- read.csv("data/overall.csv")
data_institutions <- read.csv("data/institutions.csv")

# Summarise and plot overall trend data

overall_trend <- data_overall |> 
  mutate(
    open = case_when(oa_type != "closed" ~ "open", .default = oa_type),
  ) |> 
  group_by(year, open) |> 
  summarise(
    pc = sum(pc),
  ) |> 
  filter(open == "open")

overall_trend_title <- paste0("Open Access Publication Output by New Zealand Research Institutions, 2010-", prev_year)

ggplot(overall_trend, aes(x = year, y = pc)) +
  geom_line(size = 1, colour = "#4DAF4A", show.legend = FALSE) +
  theme_classic() +
  xlab("") +
  ylab("%") +
  ylim(0, 80) +
  scale_x_continuous(n.breaks = prev_year-2010) +
  ggtitle(overall_trend_title)

ggsave("fig/1-overall-trend.png")

# Plot break down of access type

data_overall$oa_type <- factor(data_overall$oa_type, 
                             levels = c("bronze","green", "hybrid", "gold", "closed"))

overall_types_title <- (paste0("Access Status for New Zealand Research Publications, 2010-", prev_year))

ggplot(data_overall, aes(x = year, y = pc, fill = oa_type)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual( name = "Access Type", 
                     values = c("bronze" = "#A65628",
                                "hybrid" = "#377EB8",
                                "gold" = "#FFFF33",
                                "green" = "#4DAF4A",
                                "closed" = "#E41A1C")) +
  theme_classic() +
  xlab("") +
  ylab("%") +
  scale_x_continuous(n.breaks = prev_year-2010) +
  ggtitle(overall_types_title)

ggsave("fig/2-overall-types.png")
```

## Comparison of Institutions {.tabset}

### Open status over time

```{r, fig.dim = c(8, 60)}
data_institutions_sum <- data_institutions |> 
  mutate(
    open = case_when(oa_type != "closed" ~ "open", .default = oa_type),
  ) |> 
  group_by(year, institution, open) |> 
  summarise(
    pc = sum(pc),
  )

institution_title <- paste0("Open Access Publication Output for ", unique(data_institutions$institution), ", 2010-", prev_year)

plot_function_open <- function(data_institutions_sum) {
  p <- ggplot(data_institutions_sum, aes(x = year, y = pc, colour = open))
  p <- p + geom_line(size = 1) +
    scale_colour_manual(name = "Access Type", 
                        values = c("open" = "#4DAF4A",
                                   "closed" = "#E41A1C")) +
    theme_classic() +
    xlab("") +
    ylab("%") +
    ylim(0, 80) +
    scale_x_continuous(n.breaks = prev_year-2010)
  return(p)
}

plot_list <- data_institutions_sum |>
  group_by(institution) |> 
  group_split(institution) |> 
  map(~ plot_function_open(.x))

plot_list <- lapply(seq_along(plot_list), function(i) { 
  plot_list[[i]] + ggtitle(institution_title[i])
})

wrapped_plot <- patchwork::wrap_plots(plot_list, ncol = 1)

nb_plots <- length(plot_list)
baseheight <- grDevices::dev.size(units = "px")[1]
ggsave("fig/3-institutions-all.png",
       wrapped_plot,
       height = nb_plots * baseheight,
       units = "px",
       limitsize = FALSE)

wrapped_plot
```

### Access type over time

```{r, fig.dim = c(8, 60)}
institution_type_title <- paste0("Access Type Trend for ", unique(data_institutions$institution), ", 2010-", prev_year)

plot_function_type <- function(data_institutions) {
  p <- ggplot(data_institutions, aes(x = year, y = pc, colour = oa_type))
  p <- p + geom_line(size = 1) +
    scale_colour_manual(name = "Access Type", 
                       values = c("bronze" = "#A65628",
                                  "hybrid" = "#377EB8",
                                  "gold" = "#FFFF33",
                                  "green" = "#4DAF4A",
                                  "closed" = "#E41A1C")) +
    theme_classic() +
    xlab("") +
    ylab("%") +
    ylim(0, 80) +
    scale_x_continuous(n.breaks = prev_year-2010)
  return(p)
}

plot_list_type <- data_institutions |>
  group_by(institution, .add = TRUE) |>
  group_split() |> 
  map(~ plot_function_type(.x))

plot_list_type <- lapply(seq_along(plot_list_type), function(i) { 
  plot_list_type[[i]] + ggtitle(institution_type_title[i])
})

wrapped_plot_type <- patchwork::wrap_plots(plot_list_type, ncol = 1)

nb_plots_type <- length(plot_list_type)
ggsave("fig/4-institutions-type.png",
       wrapped_plot_type,
       height = nb_plots_type * baseheight,
       units = "px",
       limitsize = FALSE)

wrapped_plot_type
```

### Access type for most recent year

```{r, fig.dim = c(8, 6)}
institutions_access <- data_institutions |> 
  filter(year == prev_year) 

order_closed <- institutions_access |> 
  filter(oa_type == "closed") |> 
  arrange(desc(pc)) |> 
  select(institution)

institutions_access$institution <- factor(institutions_access$institution, 
                                          levels = pull(order_closed, institution))

institutions_access$oa_type <- factor(institutions_access$oa_type, 
                             levels = c("bronze","green", "hybrid", "gold", "closed"))

institutions_access_title <- (paste0("Access Type by Institution, ", prev_year))

ggplot(institutions_access, aes(x = institution, y = pc, fill = oa_type)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual(name = "Access Type", 
                     values = c("bronze" = "#A65628",
                                "hybrid" = "#377EB8",
                                "gold" = "#FFFF33",
                                "green" = "#4DAF4A",
                                "closed" = "#E41A1C")) +
  coord_flip() +
  theme_classic() +
  xlab("") +
  ylab("%") +
  ggtitle(institutions_access_title)

ggsave("fig/5-institutions-type-now.png")

```

##  {.unnumbered}